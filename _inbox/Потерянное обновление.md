---
aliases:
  - lost update
tags:
  - –∑—Ä–µ–ª–æ—Å—Ç—å/üå±
date:
  - - 2024-06-19
zero-link:
  - "[[00 –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö]]"
parents:
  - "[[–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π]]"
linked: 
link: https://struchkov.dev/blog/ru/transactional-isolation-levels/#%D0%BF%D0%BE%D1%82%D0%B5%D1%80%D1%8F%D0%BD%D0%BD%D0%BE%D0%B5-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5
---
**–ü–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (lost update).** –î–≤–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–µ–Ω—è—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏ —ç—Ç–æ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. ^23d01d

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ:

```java
public class LostUpdateExample {

    public static final String READ = "SELECT person.balance FROM person WHERE id = ?";
    public static final String UPDATE = "UPDATE person SET balance = ? WHERE id = ?";

    @SneakyThrows
    public static void main(String[] args) {

        // –ù–∞—á–∏–Ω–∞–µ–º –¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
        final Connection connectionOne = getNewConnection();
        final Connection connectionTwo = getNewConnection();

        // –ü–µ—Ä–≤–∞—è –∏ –≤—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        // balance = 1000
        final long balanceOne = getBalance(connectionOne);
        final long balanceTwo = getBalance(connectionTwo);

        // –ü–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∏—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        final PreparedStatement updateOne = connectionOne.prepareStatement(UPDATE);
        updateOne.setLong(1, balanceOne + 10);
        updateOne.setLong(2, 1);
        updateOne.execute();

        // –ü–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.
        // –ó–Ω–∞—á–µ–Ω–∏–µ balance –≤ –±–∞–∑–µ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç = 1010.
        connectionOne.commit();
        connectionOne.close();

        // –ù–æ –≤—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î.
        // –ó–Ω–∞—á–µ–Ω–∏–µ balanceTwo –≤—Å–µ –µ—â–µ —Ä–∞–≤–Ω–æ 1000, –∫ —ç—Ç–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é –º—ã –¥–æ–±–∞–≤–ª—è–µ–º 5.
        final PreparedStatement updateTwo = connectionTwo.prepareStatement(UPDATE);
        updateTwo.setLong(1, balanceTwo + 5);
        updateTwo.setLong(2, 1);
        updateTwo.execute();

        // –í—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–≤–æ–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.
        // –í –∏—Ç–æ–≥–µ –≤ –ë–î –æ—Å—Ç–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ 1005, –∞ –Ω–µ 1015, –∫–∞–∫ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –Ω–∞–º.
        connectionTwo.commit();
        connectionTwo.close();
    }

    private static Connection getNewConnection() throws SQLException {
        final Connection connection = Repository.getConnection();
        connection.setAutoCommit(false);
        connection.setTransactionIsolation(Connection.TRANSACTION_REPEATABLE_READ);
        return connection;
    }

    private static long getBalance(Connection connectionOne) throws SQLException {
        final PreparedStatement preparedStatement = connectionOne.prepareStatement(READ);
        preparedStatement.setLong(1, 1);
        final ResultSet resultSet = preparedStatement.executeQuery();
        resultSet.next();
        final long balanceOne = resultSet.getLong(1);
        return balanceOne;
    }

}
```

–ù–∞ —Å—Ç—Ä–æ–∫–∞—Ö 10, 11 –º—ã –ø–æ–ª—É—á–∞–µ–º 2 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–∫–ª—é—á—ë–Ω auto-commit –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏¬†[Read committed](Read%20committed.md).

–ù–∞ —Å—Ç—Ä–æ–∫–∞—Ö 15 –∏ 16 –æ–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—É—á–∞—é—Ç –±–∞–ª–∞–Ω—Å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–∞–ø–æ–º–Ω—é, —á—Ç–æ –±–∞–ª–∞–Ω—Å —Ä–∞–≤–µ–Ω 1000.

–ù–∞ —Å—Ç—Ä–æ–∫–∞—Ö 19-22 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π. –î–ª—è —ç—Ç–æ–≥–æ –∫ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º—É —Ä–∞–Ω–µ–µ –±–∞–ª–∞–Ω—Å—É –ø—Ä–∏–±–∞–≤–ª—è–µ—Ç—Å—è 10. –ù–æ —Å–µ–π—á–∞—Å —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –ë–î. –≠—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (26, 27). –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î —Ä–∞–≤–µ–Ω 1010. –ù–æ –≤—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏–¥—ë—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–µ–¥—å –±–∞–ª–∞–Ω—Å –º—ã —É–∂–µ —Å—á–∏—Ç–∞–ª–∏ –∏–∑ –ë–î, –∏ —Ç–∞–º –±—ã–ª–æ 1000.

–í—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–∏–±–∞–≤–ª—è–µ—Ç –∫ –±–∞–ª–∞–Ω—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 5 (31-34). –ü–æ—Å–ª–µ —á–µ–≥–æ –≤—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (38, 39). –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î —Ä–∞–≤–µ–Ω 1005. –ú—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∞ –ø–µ—Ä–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è. –¢–∞–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞–∑—ã–≤–∞—é—Ç [Race condition](Race%20condition.md).

–ò–∑–º–µ–Ω–∏–º —É—Ä–æ–≤–µ–Ω—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞ –±–æ–ª–µ–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π. –í –ø—Ä–∏–º–µ—Ä–µ —É –Ω–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è¬†`READ_COMMITTED`, —É—Å—Ç–∞–Ω–æ–≤–∏–º¬†[Repeatable read](Repeatable%20read.md)¬†–≤ —Å—Ç—Ä–æ–∫–µ 45.

–í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–∞—à–µ–≥–æ –∫–æ–¥–∞ –ø–æ–ª—É—á–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ¬†`PSQLException`.

![](Pasted%20image%2020240619201135.png)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- [–ü—Ä–∏–º–µ—Ä –Ω–∞ Java](https://github.com/Example-uPagge/transactional/blob/master/jdbc-transaction/src/main/java/dev/struchkov/example/transaction/problems/LostUpdateExample.java)
- ![](Pasted%20im age%2020240620094127.png)